<!doctype html>
<html lang="en">
	<head>
		<!-- META DATA -->
		<meta charset="UTF-8">
		<meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=0'>
		
		<!-- FAVICON -->
		<link rel="shortcut icon" type="image/png" href="../assets/img/yourlogo2.png" />

		<!-- TITLE -->
		<title>Vlix – FHIR CRUD - Create</title>

		<!-- STYLE CSS -->
		<link href="../assets/css/style.css" rel="stylesheet" />
	</head>

	<body>
		<!-- HEADER -->
		<header class="site-header">
			<div class="inner-wrap">
				<div class="navbar-brand-wpz">
					<font size="10">FHIR CRUD</font>
				</div>
			</div>
				
			<nav class="main-navbar" role="navigation" style="">
				<div class="inner-wrap">
					<div id="navbar-main">
						<div class="menu-main-container">
							<ul id="menu-main-1" class="navbar-wpz dropdown sf-menu sf-js-enabled sf-arrows">
								<li class="current-menu-item"><a href="Create.html">Create</a></li>
								<li><a href="Read.html">Read</a></li>
								<li><a href="Update.html">Update</a></li>
								<li><a href="Delete.html">Delete</a></li>
							</ul>
						</div>
						
					</div><!-- #navbar-main -->
				</div><!-- ./inner-wrap -->
			</nav>
		</header>
		<!-- End HEADER -->
		
		<!-- CONTENT -->
		<div id="output"></div>
		<button onclick="getPeserta('nik', '3319022010810007', '2024-06-11')">Cari Peserta by NIK</button>    &nbsp;
		<button onclick="getPeserta('noka', '0002033607464', '2024-06-11')">Cari Peserta by No Kartu BPJS</button>
		<table>
			 <colgroup>
				<col class="width30p" />
				<col class="width70p" />
			</colgroup>	
			<tr>			
				<td>ID<br>
					<input id="resourceID" placeholder="(Optional)" type="text">
				</td>
			</tr>	
			<tr>		
				<td rowspan="4">
					Content
					<textarea id="resourceContent" required placeholder="Textarea" rows="15"></textarea><br>
					<button onclick="submitForm()">Submit</button>
				</td>
			</tr>	
		</table>				
		<!-- END CONTENT -->
		
		<!-- JQUERY JS-->
		<script src="https://meal.tzuchihospital.co.id:8585/assets/js/jquery.min.js"></script>
				
		<!-- Setting JS-->
		<script src="https://meal.tzuchihospital.co.id:8585/assets/js/setting.js"></script>
		
		<!-- Encryption JS-->
		<script src="https://meal.tzuchihospital.co.id:8585/assets/js/hmac-sha256.js"></script>
		<script src="https://meal.tzuchihospital.co.id:8585/assets/js/enc-base64-min.js"></script>
		
		<script>
		/*
			VClaim variable area
		*/
		var VCLAIM_API_URL= 'https://apijkn-dev.bpjs-kesehatan.go.id/vclaim-rest-dev'
		var cons_id= "2907";
		var user_key= "10cda652f3c52080ecb7e352a8a0cbd8";
		var secret_key= "2wAB5210A1";
		var signature= "";
		var timestamp= "";
		
		function getResource(URL, ResourceName, Parameter, ResponseType, AfterFun){
			//The complete URL to request data from FHIR Server
			var url = URL + ResourceName + Parameter;
			alert(url);
			//Using XMLHttpRequest component to interact with the server
			var xhttp = new XMLHttpRequest();
			/*
				xhttp.open(method, url, async)
				@desc： Initialize components
				@param： 
					method： Using HTTP "GET" method
					url： Request path
					async： synchronously(true) or asynchronously(false)
			*/
			xhttp.open("GET", url, true);
			/*
				xhttp.setRequestHeader(header, value)
				@desc： Set the value of the HTTP header
				@param：
					header： Header name
					value： Header value
			*/
			xhttp.setRequestHeader("Content-type", 'text/' + ResponseType);
			xhttp.setRequestHeader("X-cons-id", cons_id)
			xhttp.setRequestHeader("X-timestamp", timestamp)
			xhttp.setRequestHeader("X-signature", signature)
			xhttp.setRequestHeader("user_key", user_key)
			xhttp.setRequestHeader("secretkey", secret_key)
			/*
				xhttp.onreadystatechange = callback;
				@desc：Stores a function to be called automatically each time the readyState property changes
			*/
			xhttp.onreadystatechange = function () {
				/*
					this.readyState
					@desc： Return the current status of the XMLHttpRequest
					@value：
						0: request not initialized
						1: server connection established
						2: request received (can obtained header & status)
						3: processing request
						4: request finished and response is ready
				*/
				/*
					this.status
					@desc：HTTP status messages that might be returned
					@value：
						0：UNSENT or OPENED
						200：LOADING or DONE
						403:FORBIDDEN
						404:PAGE NOT FOUND
				*/
				if (this.readyState == 4 && this.status == 200) 
				{
					var str = this.response;
					/*
						eval(string)
						@desc： Convert string to JavaScript function code for execution
					*/
					if(AfterFun)
						eval(AfterFun)(str);
					
					return str;
				}
				else if(this.readyState == 4 && this.status != 200)
				{
					alert(this.response);
				}  
			};
			/*
				xhttp.send()
				@desc： Send a request to the specified server path
			*/
			xhttp.send();
		}

		function postResource(URL, ResourceName, Parameter, ResponseType, AfterFun, RequestData){
			//The complete URL to request data from FHIR Server
			var url = URL + ResourceName + Parameter;
			//Using XMLHttpRequest component to interact with the server
			var xhttp = new XMLHttpRequest();
			/*
				xhttp.open(method, url, async)
				@desc： Initialize components
				@param： 
					method： Using HTTP "POST" method
					url： Request path
					async： synchronously(true) or asynchronously(false)
			*/
			xhttp.open("POST", url, true);
			/*
				xhttp.setRequestHeader(header, value)
				@desc： Set the value of the HTTP header
				@param：
					header： Header name
					value： Header value
			*/
			if (ResponseType!="")
				xhttp.setRequestHeader("Content-type", 'text/' + ResponseType);
				xhttp.setRequestHeader("X-cons-id", cons_id)
				xhttp.setRequestHeader("X-timestamp", timestamp)
				xhttp.setRequestHeader("X-signature", signature)
				xhttp.setRequestHeader("user_key", user_key)
				xhttp.setRequestHeader("secretkey", secret_key)
			/*
				xhttp.onreadystatechange = callback;
				@desc：Stores a function to be called automatically each time the readyState property changes
			*/
			xhttp.onreadystatechange = function () {
				/*
					this.readyState
					@desc： Return the current status of the XMLHttpRequest
					@value：
						0: request not initialized
						1: server connection established
						2: request received (can obtained header & status)
						3: processing request
						4: request finished and response is ready
				*/
				/*
					this.status
					@desc：HTTP status messages that might be returned
					@value：
						0：UNSENT or OPENED
						200：LOADING or DONE
						403:FORBIDDEN
						404:PAGE NOT FOUND
				*/
				if (this.readyState == 4 && (this.status == 200 ||　this.status == 201)) 
				{
					var str = this.response;
					//alert(str);
					/*
						eval(string)
						@desc： Convert string to JavaScript function code for execution
					*/
					eval(AfterFun)(str);
					return str;
				}
				else if(this.readyState == 4 && (this.status != 200　|| this.status != 201))
				{
					retValue(this.response);
				}  
			};
			/*
				xhttp.send()
				@desc： Send a request to the specified server path
			*/
			xhttp.send(RequestData);
		}
		
		function init(){
			getResource("https://hapi.fhir.org/baseR4/", "Patient", "/596335", ResponseType, "showContent");
			//generateSignature();
		}
		
		function getUnixTimeStamp()
		{
			return Math.floor(Date.now() / 1000)
		}
		
		function generateSignature()
		{
			timestamp= getUnixTimeStamp();
			var data= cons_id + "&" + timestamp;
			var hash = CryptoJS.HmacSHA256(data, secret_key);
			signature = CryptoJS.enc.Base64.stringify(hash);
			document.getElementById('output').innerHTML = timestamp + "\n" + signature;
		}
		
		/*Parameter
		p1= idType= Jenis dokumen
		p2= idNumber= ID Dokumen
		p3= dateSEP= tanggal SEP
		*/
		function getPeserta(idType, idNumber, dateSEP)
		{
			generateSignature();
			var tableName= "Peserta";
			var parameter= "";
			var searchParameter ;
			if (idType == "nik" )
				parameter += "/nik/";
			else if (idType == "noka" )
				parameter += "/nokartu/";
			
			parameter += idNumber + "/tglSEP/" + dateSEP;
			getResource("https://hapi.fhir.org/baseR4/", "Patient", "/596335", ResponseType, "");
			//getResource(VCLAIM_API_URL, "/" + tableName, parameter, ResponseType, "");
		}
		
		function checkSelectedOption()
		{
			var ddl = document.getElementById("resourceType");
			var resourceType = ddl.options[ddl.selectedIndex];
			var otherTextbox= document.getElementById("otherResourceType");
			
			//Check if selected resource type is "... Other resources"
			if (resourceType.value == 0)
			{
				otherTextbox.style.display= "block";
			}
			else
			{
				otherTextbox.style.display= "none";
				otherTextbox.value= "";
			}
		}
		
		function submitForm(endpoint) {
			FHIRURL = document.getElementById("FHIRServer").value;
			var ddl = document.getElementById("resourceType");
			var resourceType = ddl.options[ddl.selectedIndex];
			
			//Check if selected resource type is "... Other resources"
			if (resourceType.value == 0)
			{
				//Get the "other resource type" textbox value
				resourceType= document.getElementById("otherResourceType").value;
			}
			else
			{
				//Get the dropdownlist value
				resourceType= resourceType.text;
			}
			
			var resourceID= document.getElementById("resourceID").value;
			var resourceContent= document.getElementById("resourceContent").value;
			ResponseType= document.querySelector('input[name="content-type"]:checked').value;
			
			if(resourceID == "")
			{
				//METHOD: POST -> FHIR Resource ID will be generated based on sequence on the FHIR Server
				postResource(FHIRURL, resourceType, "", ResponseType, "retValue", resourceContent);
			}
			else
			{
				//METHOD: PUT -> When user want to customize the FHIR Resource ID
				putResource(FHIRURL, resourceType, "/" + resourceID, ResponseType, "retValue", resourceContent);
			}
		}
		
		</script>
	</body>
</html>
